<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Dashboard - Admin Belgo BBP</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/admin/css/admin.css">
    <style>
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .widget-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .widget-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .widget-card-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-card-tipo {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e0f2fe;
            color: #0369a1;
        }

        .widget-card-body {
            padding: 16px;
        }

        .widget-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .widget-card-info {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .widget-card-actions {
            padding: 12px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }

        .widget-tipo-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .widget-tipo-btn {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .widget-tipo-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .widget-tipo-btn.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }

        .widget-tipo-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .widget-tipo-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
        }

        .config-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .config-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .preview-container {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 4px;
        }

        .drag-handle:hover {
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Admin</h2>
                <span>Belgo BBP</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/index.html" class="nav-item">
                    <span class="nav-icon">&#127968;</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/projetos.html" class="nav-item">
                    <span class="nav-icon">&#128188;</span>
                    <span>Projetos</span>
                </a>
                <a href="/admin/entidades.html" class="nav-item">
                    <span class="nav-icon">&#128451;</span>
                    <span>Entidades</span>
                </a>
                <a href="/admin/menus.html" class="nav-item">
                    <span class="nav-icon">&#9776;</span>
                    <span>Menus</span>
                </a>
                <a href="/admin/dashboard-config.html" class="nav-item active">
                    <span class="nav-icon">&#128202;</span>
                    <span>Dashboard Config</span>
                </a>
                <a href="/admin/usuarios.html" class="nav-item">
                    <span class="nav-icon">&#128101;</span>
                    <span>Usuários</span>
                </a>
                <a href="/admin/projetos-membros.html" class="nav-item">
                    <span class="nav-icon">&#128101;</span>
                    <span>Membros</span>
                </a>
                <a href="/admin/auditoria.html" class="nav-item">
                    <span class="nav-icon">&#128196;</span>
                    <span>Auditoria</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="/index.html">Voltar ao Site</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <div>
                    <h1>Configurar Dashboard</h1>
                    <p>Gerencie os widgets do dashboard do projeto</p>
                </div>
                <div class="header-actions">
                    <select id="selectProjeto" class="form-control" style="width: 200px;">
                        <option value="">Selecione um projeto</option>
                    </select>
                    <button class="btn btn-primary" onclick="abrirModalNovoWidget()">
                        + Novo Widget
                    </button>
                </div>
            </div>

            <!-- Configuração Geral -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3>Configuração Geral do Dashboard</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dashboardTitulo">Titulo do Dashboard</label>
                            <input type="text" id="dashboardTitulo" class="form-control" placeholder="Dashboard">
                        </div>
                        <div class="form-group">
                            <label for="dashboardSubtitulo">Subtitulo</label>
                            <input type="text" id="dashboardSubtitulo" class="form-control" placeholder="Acompanhamento do projeto">
                        </div>
                        <div class="form-group">
                            <label for="dashboardColunas">Colunas do Grid</label>
                            <select id="dashboardColunas" class="form-control">
                                <option value="2">2 colunas</option>
                                <option value="3">3 colunas</option>
                                <option value="4" selected>4 colunas</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarConfigGeral()">
                        Salvar Configuração
                    </button>
                </div>
            </div>

            <!-- Widgets -->
            <div class="card">
                <div class="card-header">
                    <h3>Widgets do Dashboard</h3>
                </div>
                <div class="card-body">
                    <div id="widgetsGrid" class="widget-grid">
                        <!-- Widgets serao carregados aqui -->
                    </div>

                    <div id="emptyWidgets" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">&#128202;</div>
                        <h3>Nenhum widget configurado</h3>
                        <p>Clique em "Novo Widget" para adicionar widgets ao dashboard</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Novo Widget -->
    <div id="modalWidget" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="modalWidgetTitle">Novo Widget</h3>
                <button class="modal-close" onclick="fecharModalWidget()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tipo de Widget -->
                <div class="form-group">
                    <label>Tipo de Widget</label>
                    <div class="widget-tipo-selector">
                        <button type="button" class="widget-tipo-btn" data-tipo="metrica" onclick="selecionarTipo('metrica')">
                            <div class="widget-tipo-icon">&#128200;</div>
                            <div class="widget-tipo-name">Metrica</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="grafico_pizza" onclick="selecionarTipo('grafico_pizza')">
                            <div class="widget-tipo-icon">&#128992;</div>
                            <div class="widget-tipo-name">Grafico Pizza</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="grafico_barras" onclick="selecionarTipo('grafico_barras')">
                            <div class="widget-tipo-icon">&#128202;</div>
                            <div class="widget-tipo-name">Grafico Barras</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="lista" onclick="selecionarTipo('lista')">
                            <div class="widget-tipo-icon">&#128203;</div>
                            <div class="widget-tipo-name">Lista</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="progresso" onclick="selecionarTipo('progresso')">
                            <div class="widget-tipo-icon">&#9632;</div>
                            <div class="widget-tipo-name">Progresso</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="timeline" onclick="selecionarTipo('timeline')">
                            <div class="widget-tipo-icon">&#128197;</div>
                            <div class="widget-tipo-name">Timeline</div>
                        </button>
                        <button type="button" class="widget-tipo-btn" data-tipo="tabela" onclick="selecionarTipo('tabela')">
                            <div class="widget-tipo-icon">&#128203;</div>
                            <div class="widget-tipo-name">Tabela</div>
                        </button>
                    </div>
                </div>

                <!-- Campos Basicos -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="widgetCodigo">Codigo *</label>
                        <input type="text" id="widgetCodigo" class="form-control" placeholder="total_testes">
                    </div>
                    <div class="form-group">
                        <label for="widgetTitulo">Titulo *</label>
                        <input type="text" id="widgetTitulo" class="form-control" placeholder="Total de Testes">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="widgetLargura">Largura (colunas)</label>
                        <select id="widgetLargura" class="form-control">
                            <option value="1">1 coluna</option>
                            <option value="2">2 colunas</option>
                            <option value="3">3 colunas</option>
                            <option value="4">4 colunas (full)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="widgetOrdem">Ordem</label>
                        <input type="number" id="widgetOrdem" class="form-control" value="0" min="0">
                    </div>
                </div>

                <!-- Configuração por Tipo -->
                <div id="configMetrica" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Metrica</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="metricaEntidade">Entidade *</label>
                            <select id="metricaEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="metricaTipoCalculo">Tipo de Calculo</label>
                            <select id="metricaTipoCalculo" class="form-control">
                                <option value="total">Total (contagem)</option>
                                <option value="contador">Contador (filtrado)</option>
                                <option value="soma">Soma de campo</option>
                                <option value="media">Media de campo</option>
                                <option value="distinct">Valores distintos</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="metricaCampo">Campo (para soma/media/distinct)</label>
                            <input type="text" id="metricaCampo" class="form-control" placeholder="valor">
                        </div>
                        <div class="form-group">
                            <label for="metricaCor">Cor</label>
                            <select id="metricaCor" class="form-control">
                                <option value="blue">Azul</option>
                                <option value="green">Verde</option>
                                <option value="yellow">Amarelo</option>
                                <option value="red">Vermelho</option>
                                <option value="purple">Roxo</option>
                                <option value="pink">Rosa</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="metricaFiltro">Filtro (JSON)</label>
                        <input type="text" id="metricaFiltro" class="form-control" placeholder='{"status": "Concluido"}'>
                    </div>
                </div>

                <div id="configGrafico" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Grafico</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="graficoEntidade">Entidade *</label>
                            <select id="graficoEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="graficoAgruparPor">Agrupar por (campo)</label>
                            <input type="text" id="graficoAgruparPor" class="form-control" placeholder="status">
                        </div>
                    </div>
                    <div class="form-group" id="graficoOrientacaoGroup" style="display: none;">
                        <label for="graficoOrientacao">Orientacao (barras)</label>
                        <select id="graficoOrientacao" class="form-control">
                            <option value="horizontal">Horizontal</option>
                            <option value="vertical">Vertical</option>
                        </select>
                    </div>
                </div>

                <div id="configLista" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Lista</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="listaEntidade">Entidade *</label>
                            <select id="listaEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="listaLimite">Limite de itens</label>
                            <input type="number" id="listaLimite" class="form-control" value="5" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="listaCampos">Campos a exibir (separados por virgula)</label>
                        <input type="text" id="listaCampos" class="form-control" placeholder="titulo, status">
                    </div>
                    <div class="form-group">
                        <label for="listaFiltro">Filtro (JSON)</label>
                        <input type="text" id="listaFiltro" class="form-control" placeholder='{"status": "!=Resolvido"}'>
                    </div>
                </div>

                <div id="configProgresso" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Progresso</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="progressoEntidade">Entidade *</label>
                            <select id="progressoEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="progressoAgruparPor">Agrupar por</label>
                            <input type="text" id="progressoAgruparPor" class="form-control" placeholder="categoria">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="progressoCampoCompleto">Campo de status</label>
                            <input type="text" id="progressoCampoCompleto" class="form-control" placeholder="status">
                        </div>
                        <div class="form-group">
                            <label for="progressoValorCompleto">Valor completo</label>
                            <input type="text" id="progressoValorCompleto" class="form-control" placeholder="Concluido">
                        </div>
                    </div>
                </div>

                <div id="configTimeline" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Timeline</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timelineEntidade">Entidade *</label>
                            <select id="timelineEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timelineLimite">Limite de itens</label>
                            <input type="number" id="timelineLimite" class="form-control" value="10" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timelineCampoData">Campo de data</label>
                            <input type="text" id="timelineCampoData" class="form-control" placeholder="data">
                        </div>
                        <div class="form-group">
                            <label for="timelineCampoTitulo">Campo de titulo</label>
                            <input type="text" id="timelineCampoTitulo" class="form-control" placeholder="titulo">
                        </div>
                    </div>
                </div>

                <div id="configTabela" class="config-section" style="display: none;">
                    <div class="config-section-title">Configuração de Tabela</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tabelaEntidade">Entidade *</label>
                            <select id="tabelaEntidade" class="form-control">
                                <option value="">Selecione</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tabelaLimite">Limite de linhas</label>
                            <input type="number" id="tabelaLimite" class="form-control" value="10" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tabelaColunas">Colunas (separadas por virgula)</label>
                        <input type="text" id="tabelaColunas" class="form-control" placeholder="codigo, nome, status, prazo">
                    </div>
                    <div class="form-group">
                        <label for="tabelaFiltro">Filtro (JSON)</label>
                        <input type="text" id="tabelaFiltro" class="form-control" placeholder='{"status": "Pendente"}'>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalWidget()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarWidget()">Salvar Widget</button>
            </div>
        </div>
    </div>

    <script src="/shared/js/auth.js"></script>
    <script>
        let projetoId = null;
        let widgets = [];
        let entidades = [];
        let tipoSelecionado = null;
        let widgetEditando = null;

        // Inicializacao
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarProjetos();
        });

        // Carregar projetos
        async function carregarProjetos() {
            try {
                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch('/api/projetos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const select = document.getElementById('selectProjeto');

                    result.projetos.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.nome;
                        select.appendChild(option);
                    });

                    // Selecionar primeiro projeto
                    if (result.projetos.length > 0) {
                        select.value = result.projetos[0].id;
                        await selecionarProjeto(result.projetos[0].id);
                    }

                    select.addEventListener('change', (e) => selecionarProjeto(e.target.value));
                }
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
            }
        }

        // Selecionar projeto
        async function selecionarProjeto(id) {
            projetoId = id;
            await carregarEntidades();
            await carregarDashboard();
        }

        // Carregar entidades do projeto
        async function carregarEntidades() {
            try {
                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch(`/api/projetos/${projetoId}/entidades`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    entidades = result.entidades || [];
                    popularSelectsEntidades();
                }
            } catch (error) {
                console.error('Erro ao carregar entidades:', error);
            }
        }

        // Popular selects de entidades
        function popularSelectsEntidades() {
            const selects = [
                'metricaEntidade', 'graficoEntidade', 'listaEntidade',
                'progressoEntidade', 'timelineEntidade', 'tabelaEntidade'
            ];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione</option>';
                    entidades.forEach(e => {
                        const option = document.createElement('option');
                        option.value = e.codigo;
                        option.textContent = e.nome;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Carregar dashboard
        async function carregarDashboard() {
            try {
                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch(`/api/projetos/${projetoId}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();

                    // Preencher config geral
                    if (result.config) {
                        document.getElementById('dashboardTitulo').value = result.config.titulo || '';
                        document.getElementById('dashboardSubtitulo').value = result.config.subtitulo || '';
                        document.getElementById('dashboardColunas').value = result.config.colunas || 4;
                    }

                    // Renderizar widgets
                    widgets = result.widgets || [];
                    renderizarWidgets();
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Renderizar widgets
        function renderizarWidgets() {
            const grid = document.getElementById('widgetsGrid');
            const empty = document.getElementById('emptyWidgets');

            if (widgets.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            empty.style.display = 'none';

            grid.innerHTML = widgets.map(w => `
                <div class="widget-card" data-id="${w.id}">
                    <div class="widget-card-header">
                        <span class="drag-handle">&#9776;</span>
                        <span class="widget-card-tipo">${getTipoLabel(w.tipo)}</span>
                    </div>
                    <div class="widget-card-body">
                        <h4 class="widget-card-title">${w.titulo}</h4>
                        <div class="widget-card-info">
                            <p>Codigo: ${w.codigo}</p>
                            <p>Largura: ${w.largura} col</p>
                            ${w.config?.entidade ? `<p>Entidade: ${w.config.entidade}</p>` : ''}
                        </div>
                    </div>
                    <div class="widget-card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editarWidget(${w.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirWidget(${w.id})">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        function getTipoLabel(tipo) {
            const labels = {
                'metrica': 'Metrica',
                'grafico_pizza': 'Grafico Pizza',
                'grafico_barras': 'Grafico Barras',
                'lista': 'Lista',
                'progresso': 'Progresso',
                'timeline': 'Timeline',
                'tabela': 'Tabela'
            };
            return labels[tipo] || tipo;
        }

        // Salvar config geral
        async function salvarConfigGeral() {
            try {
                const config = {
                    titulo: document.getElementById('dashboardTitulo').value,
                    subtitulo: document.getElementById('dashboardSubtitulo').value,
                    colunas: parseInt(document.getElementById('dashboardColunas').value)
                };

                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch(`/api/projetos/${projetoId}/dashboard`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config })
                });

                if (response.ok) {
                    alert('Configuração salva com sucesso!');
                } else {
                    alert('Erro ao salvar configuracao');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar');
            }
        }

        // Modal Widget
        function abrirModalNovoWidget() {
            widgetEditando = null;
            tipoSelecionado = null;
            document.getElementById('modalWidgetTitle').textContent = 'Novo Widget';
            limparFormWidget();
            document.getElementById('modalWidget').style.display = 'flex';
        }

        function fecharModalWidget() {
            document.getElementById('modalWidget').style.display = 'none';
        }

        function limparFormWidget() {
            document.getElementById('widgetCodigo').value = '';
            document.getElementById('widgetTitulo').value = '';
            document.getElementById('widgetLargura').value = '1';
            document.getElementById('widgetOrdem').value = '0';

            // Limpar selecao de tipo
            document.querySelectorAll('.widget-tipo-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Esconder todas as config sections
            document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');
        }

        function selecionarTipo(tipo) {
            tipoSelecionado = tipo;

            // Atualizar visual
            document.querySelectorAll('.widget-tipo-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.tipo === tipo);
            });

            // Mostrar config section correspondente
            document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');

            switch (tipo) {
                case 'metrica':
                    document.getElementById('configMetrica').style.display = 'block';
                    break;
                case 'grafico_pizza':
                case 'grafico_barras':
                    document.getElementById('configGrafico').style.display = 'block';
                    document.getElementById('graficoOrientacaoGroup').style.display =
                        tipo === 'grafico_barras' ? 'block' : 'none';
                    break;
                case 'lista':
                    document.getElementById('configLista').style.display = 'block';
                    break;
                case 'progresso':
                    document.getElementById('configProgresso').style.display = 'block';
                    break;
                case 'timeline':
                    document.getElementById('configTimeline').style.display = 'block';
                    break;
                case 'tabela':
                    document.getElementById('configTabela').style.display = 'block';
                    break;
            }
        }

        // Salvar widget
        async function salvarWidget() {
            const codigo = document.getElementById('widgetCodigo').value.trim();
            const titulo = document.getElementById('widgetTitulo').value.trim();
            const largura = parseInt(document.getElementById('widgetLargura').value);
            const ordem = parseInt(document.getElementById('widgetOrdem').value);

            if (!tipoSelecionado || !codigo || !titulo) {
                alert('Preencha todos os campos obrigatorios');
                return;
            }

            // Montar config baseado no tipo
            let config = {};

            switch (tipoSelecionado) {
                case 'metrica':
                    config = {
                        entidade: document.getElementById('metricaEntidade').value,
                        tipo_calculo: document.getElementById('metricaTipoCalculo').value,
                        campo: document.getElementById('metricaCampo').value || null,
                        cor: document.getElementById('metricaCor').value,
                        filtro: parseJSON(document.getElementById('metricaFiltro').value)
                    };
                    break;
                case 'grafico_pizza':
                case 'grafico_barras':
                    config = {
                        entidade: document.getElementById('graficoEntidade').value,
                        agrupar_por: document.getElementById('graficoAgruparPor').value,
                        orientacao: tipoSelecionado === 'grafico_barras' ?
                            document.getElementById('graficoOrientacao').value : null
                    };
                    break;
                case 'lista':
                    config = {
                        entidade: document.getElementById('listaEntidade').value,
                        limite: parseInt(document.getElementById('listaLimite').value),
                        campos_exibir: document.getElementById('listaCampos').value.split(',').map(s => s.trim()).filter(Boolean),
                        filtro: parseJSON(document.getElementById('listaFiltro').value)
                    };
                    break;
                case 'progresso':
                    config = {
                        entidade: document.getElementById('progressoEntidade').value,
                        agrupar_por: document.getElementById('progressoAgruparPor').value,
                        campo_completo: document.getElementById('progressoCampoCompleto').value,
                        valor_completo: document.getElementById('progressoValorCompleto').value
                    };
                    break;
                case 'timeline':
                    config = {
                        entidade: document.getElementById('timelineEntidade').value,
                        limite: parseInt(document.getElementById('timelineLimite').value),
                        campo_data: document.getElementById('timelineCampoData').value,
                        campo_titulo: document.getElementById('timelineCampoTitulo').value
                    };
                    break;
                case 'tabela':
                    config = {
                        entidade: document.getElementById('tabelaEntidade').value,
                        limite: parseInt(document.getElementById('tabelaLimite').value),
                        colunas: document.getElementById('tabelaColunas').value.split(',').map(s => s.trim()).filter(Boolean),
                        filtro: parseJSON(document.getElementById('tabelaFiltro').value)
                    };
                    break;
            }

            try {
                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch(`/api/projetos/${projetoId}/dashboard`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        codigo,
                        tipo: tipoSelecionado,
                        titulo,
                        config,
                        largura,
                        ordem
                    })
                });

                if (response.ok) {
                    fecharModalWidget();
                    await carregarDashboard();
                    alert('Widget salvo com sucesso!');
                } else {
                    const result = await response.json();
                    alert(result.error || 'Erro ao salvar widget');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar widget');
            }
        }

        function parseJSON(str) {
            if (!str) return null;
            try {
                return JSON.parse(str);
            } catch {
                return null;
            }
        }

        // Editar widget
        function editarWidget(id) {
            const widget = widgets.find(w => w.id === id);
            if (!widget) return;

            widgetEditando = widget;
            document.getElementById('modalWidgetTitle').textContent = 'Editar Widget';

            document.getElementById('widgetCodigo').value = widget.codigo;
            document.getElementById('widgetTitulo').value = widget.titulo;
            document.getElementById('widgetLargura').value = widget.largura || 1;
            document.getElementById('widgetOrdem').value = widget.ordem || 0;

            selecionarTipo(widget.tipo);

            // Preencher config
            const config = widget.config || {};

            switch (widget.tipo) {
                case 'metrica':
                    document.getElementById('metricaEntidade').value = config.entidade || '';
                    document.getElementById('metricaTipoCalculo').value = config.tipo_calculo || 'total';
                    document.getElementById('metricaCampo').value = config.campo || '';
                    document.getElementById('metricaCor').value = config.cor || 'blue';
                    document.getElementById('metricaFiltro').value = config.filtro ? JSON.stringify(config.filtro) : '';
                    break;
                case 'grafico_pizza':
                case 'grafico_barras':
                    document.getElementById('graficoEntidade').value = config.entidade || '';
                    document.getElementById('graficoAgruparPor').value = config.agrupar_por || '';
                    document.getElementById('graficoOrientacao').value = config.orientacao || 'horizontal';
                    break;
                case 'lista':
                    document.getElementById('listaEntidade').value = config.entidade || '';
                    document.getElementById('listaLimite').value = config.limite || 5;
                    document.getElementById('listaCampos').value = (config.campos_exibir || []).join(', ');
                    document.getElementById('listaFiltro').value = config.filtro ? JSON.stringify(config.filtro) : '';
                    break;
                case 'progresso':
                    document.getElementById('progressoEntidade').value = config.entidade || '';
                    document.getElementById('progressoAgruparPor').value = config.agrupar_por || '';
                    document.getElementById('progressoCampoCompleto').value = config.campo_completo || '';
                    document.getElementById('progressoValorCompleto').value = config.valor_completo || '';
                    break;
                case 'timeline':
                    document.getElementById('timelineEntidade').value = config.entidade || '';
                    document.getElementById('timelineLimite').value = config.limite || 10;
                    document.getElementById('timelineCampoData').value = config.campo_data || '';
                    document.getElementById('timelineCampoTitulo').value = config.campo_titulo || '';
                    break;
                case 'tabela':
                    document.getElementById('tabelaEntidade').value = config.entidade || '';
                    document.getElementById('tabelaLimite').value = config.limite || 10;
                    document.getElementById('tabelaColunas').value = (config.colunas || []).join(', ');
                    document.getElementById('tabelaFiltro').value = config.filtro ? JSON.stringify(config.filtro) : '';
                    break;
            }

            document.getElementById('modalWidget').style.display = 'flex';
        }

        // Excluir widget
        async function excluirWidget(id) {
            if (!confirm('Deseja excluir este widget?')) return;

            try {
                const token = sessionStorage.getItem('belgo_token');
                const response = await fetch(`/api/projetos/${projetoId}/dashboard?widgetId=${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    await carregarDashboard();
                    alert('Widget excluido!');
                } else {
                    alert('Erro ao excluir widget');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir');
            }
        }

        // Auth check
        document.addEventListener('DOMContentLoaded', () => {
            if (!sessionStorage.getItem('belgo_token')) {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
            }
        });
    </script>
</body>
</html>
