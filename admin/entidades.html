<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entidades - Admin Belgo BBP</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>BELGO BBP</h1>
                <span class="badge">Admin</span>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
                <a href="usuarios.html" class="nav-item">
                    <span class="icon">üë•</span>
                    Usuarios
                </a>
                <a href="projetos.html" class="nav-item">
                    <span class="icon">üìÅ</span>
                    Projetos
                </a>
                <a href="entidades.html" class="nav-item active">
                    <span class="icon">üìã</span>
                    Entidades
                </a>
                <a href="auditoria.html" class="nav-item">
                    <span class="icon">üìã</span>
                    Auditoria
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="../landing.html" class="nav-item">
                    <span class="icon">üè†</span>
                    Voltar ao Portal
                </a>
                <button class="nav-item btn-logout" onclick="logout()">
                    <span class="icon">üö™</span>
                    Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <div class="header-title">
                    <h2>Entidades do Projeto</h2>
                    <select id="selectProjeto" class="select-projeto" onchange="carregarEntidades()">
                        <option value="">Selecione um projeto</option>
                    </select>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="abrirModalNovaEntidade()" id="btnNovaEntidade" disabled>
                        <span class="icon">‚ûï</span>
                        Nova Entidade
                    </button>
                </div>
            </header>

            <div class="content-body">
                <!-- Info do Projeto -->
                <div class="projeto-info-banner" id="projetoInfo" style="display: none;">
                    <div class="projeto-banner-content">
                        <span class="projeto-icone" id="projetoIcone">üìÅ</span>
                        <div>
                            <h3 id="projetoNome">-</h3>
                            <p id="projetoDescricao">-</p>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid stats-4" id="statsSection" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalEntidades">0</span>
                            <span class="stat-label">Entidades</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalCampos">0</span>
                            <span class="stat-label">Campos</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíæ</div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalRegistros">0</span>
                            <span class="stat-label">Registros</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÑ</div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalMenus">0</span>
                            <span class="stat-label">Menus Vinculados</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Entidades -->
                <div class="card" id="entidadesSection" style="display: none;">
                    <div class="card-header">
                        <h3>Entidades</h3>
                        <div class="search-box">
                            <input type="text" id="searchEntidades" placeholder="Buscar entidades..." onkeyup="filtrarEntidades()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="entidades-grid" id="entidadesGrid">
                            <p class="empty">Nenhuma entidade configurada</p>
                        </div>
                    </div>
                </div>

                <!-- Instrucoes iniciais -->
                <div class="card" id="instrucoes">
                    <div class="card-body">
                        <div class="instrucoes-content">
                            <span class="instrucoes-icon">üìã</span>
                            <h3>Gestao de Entidades</h3>
                            <p>Selecione um projeto para gerenciar suas entidades de dados.</p>
                            <p>Entidades definem estruturas de dados dinamicas que podem ser usadas nos menus do projeto.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nova/Editar Entidade -->
    <div class="modal" id="modalEntidade">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 id="modalEntidadeTitulo">Nova Entidade</h3>
                <button class="modal-close" onclick="fecharModalEntidade()">&times;</button>
            </div>
            <form id="formEntidade" onsubmit="salvarEntidade(event)">
                <div class="modal-body">
                    <input type="hidden" id="entidadeId">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="entidadeCodigo">Codigo *</label>
                            <input type="text" id="entidadeCodigo" required
                                   pattern="[a-z0-9_]+"
                                   placeholder="ex: revendas"
                                   title="Apenas letras minusculas, numeros e underscores">
                        </div>
                        <div class="form-group">
                            <label for="entidadeNome">Nome *</label>
                            <input type="text" id="entidadeNome" required placeholder="Nome da entidade">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="entidadeNomePlural">Nome Plural</label>
                            <input type="text" id="entidadeNomePlural" placeholder="ex: Revendas">
                        </div>
                        <div class="form-group">
                            <label for="entidadeIcone">Icone</label>
                            <input type="text" id="entidadeIcone" placeholder="üìã" maxlength="4">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="entidadeDescricao">Descricao</label>
                        <textarea id="entidadeDescricao" rows="2" placeholder="Descricao da entidade"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="entidadeTipo">Tipo</label>
                        <select id="entidadeTipo">
                            <option value="tabela">Tabela (dados estruturados)</option>
                            <option value="documento">Documento (textos)</option>
                            <option value="arquivo">Arquivo (uploads)</option>
                        </select>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Permissoes</h4>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="permiteCriar" checked>
                                <span class="checkbox-label">Criar</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="permiteEditar" checked>
                                <span class="checkbox-label">Editar</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="permiteExcluir" checked>
                                <span class="checkbox-label">Excluir</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="permiteImportar" checked>
                                <span class="checkbox-label">Importar</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="permiteExportar" checked>
                                <span class="checkbox-label">Exportar</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalEntidade()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gerenciar Campos -->
    <div class="modal" id="modalCampos">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="modalCamposTitulo">Campos da Entidade</h3>
                <button class="modal-close" onclick="fecharModalCampos()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="campos-toolbar">
                    <button class="btn btn-primary btn-sm" onclick="abrirModalNovoCampo()">
                        <span class="icon">‚ûï</span> Novo Campo
                    </button>
                </div>
                <div class="campos-list" id="camposList">
                    <p class="empty">Nenhum campo configurado</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModalCampos()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Campo -->
    <div class="modal" id="modalCampo">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 id="modalCampoTitulo">Novo Campo</h3>
                <button class="modal-close" onclick="fecharModalCampo()">&times;</button>
            </div>
            <form id="formCampo" onsubmit="salvarCampo(event)">
                <div class="modal-body">
                    <input type="hidden" id="campoId">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="campoCodigo">Codigo *</label>
                            <input type="text" id="campoCodigo" required
                                   pattern="[a-z0-9_]+"
                                   placeholder="ex: nome_fantasia"
                                   title="Apenas letras minusculas, numeros e underscores">
                        </div>
                        <div class="form-group">
                            <label for="campoNome">Nome *</label>
                            <input type="text" id="campoNome" required placeholder="Nome do campo">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="campoTipo">Tipo *</label>
                            <select id="campoTipo" required onchange="atualizarOpcoesTipo()">
                                <option value="text">Texto</option>
                                <option value="textarea">Texto Longo</option>
                                <option value="number">Numero</option>
                                <option value="currency">Moeda</option>
                                <option value="date">Data</option>
                                <option value="datetime">Data e Hora</option>
                                <option value="boolean">Sim/Nao</option>
                                <option value="select">Selecao (dropdown)</option>
                                <option value="multiselect">Selecao Multipla</option>
                                <option value="file">Arquivo</option>
                                <option value="image">Imagem</option>
                                <option value="relation">Relacao (outra entidade)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="campoOrdem">Ordem</label>
                            <input type="number" id="campoOrdem" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="campoDescricao">Descricao</label>
                        <input type="text" id="campoDescricao" placeholder="Descricao do campo">
                    </div>

                    <!-- Opcoes para select -->
                    <div class="form-section" id="secaoOpcoes" style="display: none;">
                        <h4 class="form-section-title">Opcoes</h4>
                        <div id="opcoesContainer"></div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="adicionarOpcao()">
                            <span class="icon">‚ûï</span> Adicionar Opcao
                        </button>
                    </div>

                    <!-- Relacao -->
                    <div class="form-section" id="secaoRelacao" style="display: none;">
                        <h4 class="form-section-title">Configuracao de Relacao</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="relacaoEntidade">Entidade Relacionada</label>
                                <select id="relacaoEntidade">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="relacaoCampoExibir">Campo para Exibir</label>
                                <input type="text" id="relacaoCampoExibir" placeholder="ex: nome">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Validacao</h4>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="campoObrigatorio">
                                <span class="checkbox-label">Obrigatorio</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="campoUnico">
                                <span class="checkbox-label">Unico</span>
                            </label>
                        </div>
                        <div class="form-row" style="margin-top: 12px;">
                            <div class="form-group">
                                <label for="campoValorPadrao">Valor Padrao</label>
                                <input type="text" id="campoValorPadrao" placeholder="Valor inicial">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Visibilidade</h4>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="campoVisivelListagem" checked>
                                <span class="checkbox-label">Listagem</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="campoVisivelFormulario" checked>
                                <span class="checkbox-label">Formulario</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="campoVisivelMobile" checked>
                                <span class="checkbox-label">Mobile</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalCampo()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Layout Builder -->
    <div class="modal" id="modalLayoutBuilder">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="modalLayoutTitulo">Configurar Layout</h3>
                <button class="modal-close" onclick="fecharLayoutBuilder()">&times;</button>
            </div>
            <div class="modal-body layout-builder-body">
                <input type="hidden" id="layoutEntidadeId">

                <!-- Tabs de navegacao -->
                <div class="layout-tabs">
                    <button class="layout-tab active" onclick="mostrarSecaoLayout('layout')">
                        <span class="icon">üìä</span> Layout
                    </button>
                    <button class="layout-tab" onclick="mostrarSecaoLayout('colunas')">
                        <span class="icon">üìã</span> Colunas
                    </button>
                    <button class="layout-tab" onclick="mostrarSecaoLayout('filtros')">
                        <span class="icon">üîç</span> Filtros
                    </button>
                    <button class="layout-tab" onclick="mostrarSecaoLayout('metricas')">
                        <span class="icon">üìà</span> Metricas
                    </button>
                    <button class="layout-tab" onclick="mostrarSecaoLayout('acoes')">
                        <span class="icon">‚ö°</span> Acoes
                    </button>
                </div>

                <!-- Secao Layout -->
                <div class="layout-section active" id="secaoLayout">
                    <h4>Tipo de Visualizacao</h4>
                    <div class="layout-type-grid">
                        <button type="button" class="layout-type-btn" data-layout="tabela" onclick="selecionarLayoutTipo('tabela')">
                            <span class="layout-type-icon">üìä</span>
                            <span class="layout-type-nome">Tabela</span>
                            <span class="layout-type-desc">Dados em formato de tabela tradicional</span>
                        </button>
                        <button type="button" class="layout-type-btn" data-layout="cards" onclick="selecionarLayoutTipo('cards')">
                            <span class="layout-type-icon">üÉè</span>
                            <span class="layout-type-nome">Cards</span>
                            <span class="layout-type-desc">Cards em lista vertical</span>
                        </button>
                        <button type="button" class="layout-type-btn" data-layout="cards_grid" onclick="selecionarLayoutTipo('cards_grid')">
                            <span class="layout-type-icon">‚äû</span>
                            <span class="layout-type-nome">Cards Grid</span>
                            <span class="layout-type-desc">Cards em grade responsiva</span>
                        </button>
                        <button type="button" class="layout-type-btn" data-layout="cards_agrupados" onclick="selecionarLayoutTipo('cards_agrupados')">
                            <span class="layout-type-icon">üìÅ</span>
                            <span class="layout-type-nome">Agrupado</span>
                            <span class="layout-type-desc">Cards agrupados por campo</span>
                        </button>
                        <button type="button" class="layout-type-btn" data-layout="timeline" onclick="selecionarLayoutTipo('timeline')">
                            <span class="layout-type-icon">üìÖ</span>
                            <span class="layout-type-nome">Timeline</span>
                            <span class="layout-type-desc">Linha do tempo cronologica</span>
                        </button>
                    </div>

                    <!-- Opcoes de agrupamento (visivel quando cards_agrupados) -->
                    <div class="layout-subsection" id="opcoesAgrupamento" style="display: none;">
                        <h5>Opcoes de Agrupamento</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="campoAgrupamento">Campo para Agrupar</label>
                                <select id="campoAgrupamento">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Opcoes de timeline (visivel quando timeline) -->
                    <div class="layout-subsection" id="opcoesTimeline" style="display: none;">
                        <h5>Configuracao da Timeline</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timelineCampoData">Campo de Data</label>
                                <select id="timelineCampoData">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="timelineCampoTitulo">Campo de Titulo</label>
                                <select id="timelineCampoTitulo">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="timelineCampoDescricao">Campo de Descricao</label>
                                <select id="timelineCampoDescricao">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Opcoes de avatar (visivel quando cards_grid) -->
                    <div class="layout-subsection" id="opcoesAvatar" style="display: none;">
                        <h5>Configuracao do Avatar</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="avatarCampo">Campo do Nome</label>
                                <select id="avatarCampo">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="avatarCorPor">Cor por Campo (opcional)</label>
                                <select id="avatarCorPor">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secao Colunas -->
                <div class="layout-section" id="secaoColunas">
                    <h4>Colunas Visiveis na Listagem</h4>
                    <p class="section-help">Arraste para reordenar. Marque os campos que devem aparecer na listagem.</p>
                    <div class="colunas-list" id="colunasListBuilder">
                        <p class="loading">Carregando campos...</p>
                    </div>
                </div>

                <!-- Secao Secoes do Card (visivel apenas para layouts de cards) -->
                <div class="layout-section" id="secaoSecoesCard" style="display: none;">
                    <h4>Secoes do Card</h4>
                    <p class="section-help">Configure secoes especiais para exibicao rica de conteudo nos cards.</p>

                    <div class="secoes-builder">
                        <div class="secoes-list" id="secoesListBuilder">
                            <!-- Renderizado via JS -->
                        </div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="adicionarSecaoCard()">
                            <span class="icon">‚ûï</span> Adicionar Secao
                        </button>
                    </div>
                </div>

                <!-- Secao Filtros -->
                <div class="layout-section" id="secaoFiltros">
                    <h4>Filtros Disponiveis</h4>
                    <p class="section-help">Configure os filtros que aparecerao acima da listagem.</p>

                    <div class="filtros-builder">
                        <div class="filtros-list" id="filtrosListBuilder">
                            <!-- Renderizado via JS -->
                        </div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="adicionarFiltro()">
                            <span class="icon">‚ûï</span> Adicionar Filtro
                        </button>
                    </div>

                    <h5 style="margin-top: 20px;">Botoes de Filtro Rapido</h5>
                    <p class="section-help">Botoes para filtrar rapidamente por valores especificos.</p>
                    <div class="filtros-rapidos-list" id="filtrosRapidosListBuilder">
                        <!-- Renderizado via JS -->
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="adicionarFiltroRapido()">
                        <span class="icon">‚ûï</span> Adicionar Botao de Filtro
                    </button>
                </div>

                <!-- Secao Metricas -->
                <div class="layout-section" id="secaoMetricas">
                    <h4>Cards de Metricas</h4>
                    <p class="section-help">Cards com contadores e estatisticas exibidos acima da listagem.</p>

                    <div class="metricas-builder">
                        <label class="checkbox-item" style="margin-bottom: 16px;">
                            <input type="checkbox" id="habilitarMetricas" onchange="toggleMetricas()">
                            <span class="checkbox-label">Habilitar metricas</span>
                        </label>

                        <div id="metricasConfig" style="display: none;">
                            <div class="metricas-list" id="metricasListBuilder">
                                <!-- Renderizado via JS -->
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="adicionarMetrica()">
                                <span class="icon">‚ûï</span> Adicionar Metrica
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Secao Acoes -->
                <div class="layout-section" id="secaoAcoes">
                    <h4>Acoes Disponiveis</h4>
                    <p class="section-help">Acoes que podem ser executadas nos registros.</p>

                    <div class="acoes-builder">
                        <h5>Acoes de Linha</h5>
                        <div class="acoes-checklist" id="acoesLinhaBuilder">
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoVerDetalhes" checked>
                                <span class="checkbox-label">Ver Detalhes (modal)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoEditar">
                                <span class="checkbox-label">Editar</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoExcluir">
                                <span class="checkbox-label">Excluir</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoTeams">
                                <span class="checkbox-label">Compartilhar no Teams</span>
                            </label>
                        </div>

                        <h5 style="margin-top: 20px;">Acoes de Status</h5>
                        <p class="section-help">Botoes para alterar status rapidamente. Requer um campo tipo "select" com status.</p>
                        <div class="status-acoes-list" id="statusAcoesBuilder">
                            <!-- Renderizado via JS -->
                        </div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="adicionarAcaoStatus()">
                            <span class="icon">‚ûï</span> Adicionar Acao de Status
                        </button>

                        <h5 style="margin-top: 20px;">Acoes em Massa</h5>
                        <div class="acoes-checklist">
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoExportarCSV">
                                <span class="checkbox-label">Exportar CSV</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="acaoImportarCSV">
                                <span class="checkbox-label">Importar CSV</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharLayoutBuilder()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarLayoutConfig()">
                    <span class="icon">üíæ</span> Salvar Configuracao
                </button>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        let projetos = [];
        let projetoAtual = null;
        let entidades = [];
        let entidadeAtual = null;
        let campos = [];
        let opcoesIndex = 0;

        // Toast notification
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span class="toast-message">${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('toast-hide');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Carregar projetos
        async function carregarProjetos() {
            try {
                const res = await apiRequest('/api/projetos');
                if (res.success) {
                    projetos = res.projetos;
                    const select = document.getElementById('selectProjeto');
                    select.innerHTML = '<option value="">Selecione um projeto</option>' +
                        projetos.map(p => `<option value="${p.id}">${p.icone || 'üìÅ'} ${p.nome}</option>`).join('');

                    // Verificar se tem projeto na URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const projetoId = urlParams.get('projeto');
                    if (projetoId) {
                        select.value = projetoId;
                        carregarEntidades();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                showToast('Erro ao carregar projetos', 'error');
            }
        }

        // Carregar entidades do projeto
        async function carregarEntidades() {
            const projetoId = document.getElementById('selectProjeto').value;

            if (!projetoId) {
                document.getElementById('instrucoes').style.display = 'block';
                document.getElementById('projetoInfo').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('entidadesSection').style.display = 'none';
                document.getElementById('btnNovaEntidade').disabled = true;
                return;
            }

            try {
                // Carregar info do projeto
                const projetoRes = await apiRequest(`/api/projetos/${projetoId}`);
                if (projetoRes.success) {
                    projetoAtual = projetoRes.projeto;
                    document.getElementById('projetoIcone').textContent = projetoAtual.icone || 'üìÅ';
                    document.getElementById('projetoNome').textContent = projetoAtual.nome;
                    document.getElementById('projetoDescricao').textContent = projetoAtual.descricao || '';
                    document.getElementById('projetoInfo').style.display = 'flex';
                }

                // Carregar entidades
                const res = await apiRequest(`/api/projetos/${projetoId}/entidades`);
                if (res.success) {
                    entidades = res.entidades;
                    renderizarEntidades();
                    atualizarEstatisticas();

                    document.getElementById('instrucoes').style.display = 'none';
                    document.getElementById('statsSection').style.display = 'grid';
                    document.getElementById('entidadesSection').style.display = 'block';
                    document.getElementById('btnNovaEntidade').disabled = false;

                    // Atualizar URL
                    const url = new URL(window.location);
                    url.searchParams.set('projeto', projetoId);
                    window.history.replaceState({}, '', url);
                }
            } catch (error) {
                console.error('Erro ao carregar entidades:', error);
                showToast('Erro ao carregar entidades', 'error');
            }
        }

        // Renderizar grid de entidades
        function renderizarEntidades() {
            const container = document.getElementById('entidadesGrid');

            if (entidades.length === 0) {
                container.innerHTML = '<p class="empty">Nenhuma entidade configurada. Clique em "Nova Entidade" para criar.</p>';
                return;
            }

            container.innerHTML = entidades.map(e => `
                <div class="entidade-card">
                    <div class="entidade-header">
                        <span class="entidade-icone">${e.icone || 'üìã'}</span>
                        <div class="entidade-info">
                            <h4 class="entidade-nome">${e.nome}</h4>
                            <span class="entidade-codigo">${e.codigo}</span>
                        </div>
                        <span class="entidade-tipo tipo-${e.tipo}">${e.tipo}</span>
                    </div>
                    ${e.descricao ? `<p class="entidade-descricao">${e.descricao}</p>` : ''}
                    <div class="entidade-permissoes">
                        ${e.permite_criar ? '<span class="perm-badge">Criar</span>' : ''}
                        ${e.permite_editar ? '<span class="perm-badge">Editar</span>' : ''}
                        ${e.permite_excluir ? '<span class="perm-badge">Excluir</span>' : ''}
                        ${e.permite_importar ? '<span class="perm-badge">Importar</span>' : ''}
                        ${e.permite_exportar ? '<span class="perm-badge">Exportar</span>' : ''}
                    </div>
                    <div class="entidade-actions">
                        <button class="btn btn-sm btn-outline" onclick="gerenciarCampos(${e.id})">
                            <span class="icon">üìù</span> Campos
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="abrirLayoutBuilder(${e.id})" title="Configurar Layout">
                            <span class="icon">üé®</span> Layout
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="editarEntidade(${e.id})">
                            <span class="icon">‚úèÔ∏è</span> Editar
                        </button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="confirmarExclusaoEntidade(${e.id}, '${e.nome}')">
                            <span class="icon">üóëÔ∏è</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar estatisticas
        function atualizarEstatisticas() {
            document.getElementById('totalEntidades').textContent = entidades.length;

            // Contar campos total (seria necessario uma API agregada)
            document.getElementById('totalCampos').textContent = '-';
            document.getElementById('totalRegistros').textContent = '-';
            document.getElementById('totalMenus').textContent = '-';
        }

        // Filtrar entidades
        function filtrarEntidades() {
            const termo = document.getElementById('searchEntidades').value.toLowerCase();

            if (!termo) {
                renderizarEntidades();
                return;
            }

            const filtradas = entidades.filter(e =>
                e.nome.toLowerCase().includes(termo) ||
                e.codigo.toLowerCase().includes(termo) ||
                (e.descricao && e.descricao.toLowerCase().includes(termo))
            );

            const container = document.getElementById('entidadesGrid');
            if (filtradas.length === 0) {
                container.innerHTML = '<p class="empty">Nenhuma entidade encontrada</p>';
                return;
            }

            const backup = entidades;
            entidades = filtradas;
            renderizarEntidades();
            entidades = backup;
        }

        // Abrir modal nova entidade
        function abrirModalNovaEntidade() {
            entidadeAtual = null;
            document.getElementById('modalEntidadeTitulo').textContent = 'Nova Entidade';
            document.getElementById('formEntidade').reset();
            document.getElementById('entidadeId').value = '';
            document.getElementById('entidadeCodigo').disabled = false;
            document.getElementById('modalEntidade').classList.add('active');
        }

        // Editar entidade
        async function editarEntidade(id) {
            try {
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${id}`);
                if (!res.success) {
                    showToast('Erro ao carregar entidade', 'error');
                    return;
                }

                const e = res.entidade;
                entidadeAtual = e;

                document.getElementById('modalEntidadeTitulo').textContent = 'Editar Entidade';
                document.getElementById('entidadeId').value = e.id;
                document.getElementById('entidadeCodigo').value = e.codigo;
                document.getElementById('entidadeCodigo').disabled = true;
                document.getElementById('entidadeNome').value = e.nome;
                document.getElementById('entidadeNomePlural').value = e.nome_plural || '';
                document.getElementById('entidadeIcone').value = e.icone || '';
                document.getElementById('entidadeDescricao').value = e.descricao || '';
                document.getElementById('entidadeTipo').value = e.tipo || 'tabela';
                document.getElementById('permiteCriar').checked = e.permite_criar;
                document.getElementById('permiteEditar').checked = e.permite_editar;
                document.getElementById('permiteExcluir').checked = e.permite_excluir;
                document.getElementById('permiteImportar').checked = e.permite_importar;
                document.getElementById('permiteExportar').checked = e.permite_exportar;

                document.getElementById('modalEntidade').classList.add('active');
            } catch (error) {
                console.error('Erro ao carregar entidade:', error);
                showToast('Erro ao carregar entidade', 'error');
            }
        }

        // Salvar entidade
        async function salvarEntidade(event) {
            event.preventDefault();

            const id = document.getElementById('entidadeId').value;
            const isEdicao = !!id;

            const dados = {
                codigo: document.getElementById('entidadeCodigo').value,
                nome: document.getElementById('entidadeNome').value,
                nome_plural: document.getElementById('entidadeNomePlural').value || null,
                descricao: document.getElementById('entidadeDescricao').value || null,
                icone: document.getElementById('entidadeIcone').value || 'üìã',
                tipo: document.getElementById('entidadeTipo').value,
                permite_criar: document.getElementById('permiteCriar').checked,
                permite_editar: document.getElementById('permiteEditar').checked,
                permite_excluir: document.getElementById('permiteExcluir').checked,
                permite_importar: document.getElementById('permiteImportar').checked,
                permite_exportar: document.getElementById('permiteExportar').checked
            };

            try {
                const url = isEdicao
                    ? `/api/projetos/${projetoAtual.id}/entidades/${id}`
                    : `/api/projetos/${projetoAtual.id}/entidades`;
                const method = isEdicao ? 'PUT' : 'POST';

                const res = await apiRequest(url, {
                    method,
                    body: JSON.stringify(dados)
                });

                if (res.success) {
                    showToast(isEdicao ? 'Entidade atualizada!' : 'Entidade criada!', 'success');
                    fecharModalEntidade();
                    carregarEntidades();
                } else {
                    showToast(res.error || 'Erro ao salvar', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar entidade:', error);
                showToast('Erro ao salvar entidade', 'error');
            }
        }

        // Fechar modal entidade
        function fecharModalEntidade() {
            document.getElementById('modalEntidade').classList.remove('active');
        }

        // Confirmar exclusao
        function confirmarExclusaoEntidade(id, nome) {
            if (confirm(`Deseja realmente excluir a entidade "${nome}"?\n\nTodos os campos e dados associados serao perdidos.`)) {
                excluirEntidade(id);
            }
        }

        // Excluir entidade
        async function excluirEntidade(id) {
            try {
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${id}`, {
                    method: 'DELETE'
                });

                if (res.success) {
                    showToast('Entidade excluida!', 'success');
                    carregarEntidades();
                } else {
                    showToast(res.error || 'Erro ao excluir', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir entidade:', error);
                showToast('Erro ao excluir entidade', 'error');
            }
        }

        // =========================================
        // CAMPOS
        // =========================================

        // Gerenciar campos
        async function gerenciarCampos(entidadeId) {
            try {
                // Buscar entidade com campos
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${entidadeId}`);
                if (!res.success) {
                    showToast('Erro ao carregar campos', 'error');
                    return;
                }

                entidadeAtual = res.entidade;
                campos = res.entidade.campos || [];

                document.getElementById('modalCamposTitulo').textContent = `Campos: ${entidadeAtual.nome}`;
                renderizarCampos();

                // Carregar entidades para relacao
                const selectRelacao = document.getElementById('relacaoEntidade');
                selectRelacao.innerHTML = '<option value="">Selecione...</option>' +
                    entidades.filter(e => e.id !== entidadeId).map(e =>
                        `<option value="${e.id}">${e.nome}</option>`
                    ).join('');

                document.getElementById('modalCampos').classList.add('active');
            } catch (error) {
                console.error('Erro ao carregar campos:', error);
                showToast('Erro ao carregar campos', 'error');
            }
        }

        // Renderizar lista de campos
        function renderizarCampos() {
            const container = document.getElementById('camposList');

            if (campos.length === 0) {
                container.innerHTML = '<p class="empty">Nenhum campo configurado. Clique em "Novo Campo" para criar.</p>';
                return;
            }

            container.innerHTML = `
                <table class="campos-table">
                    <thead>
                        <tr>
                            <th>Ordem</th>
                            <th>Codigo</th>
                            <th>Nome</th>
                            <th>Tipo</th>
                            <th>Obrig.</th>
                            <th>Unico</th>
                            <th>Acoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${campos.map(c => `
                            <tr>
                                <td>${c.ordem}</td>
                                <td><code>${c.codigo}</code></td>
                                <td>${c.nome}</td>
                                <td><span class="tipo-badge tipo-${c.tipo}">${c.tipo}</span></td>
                                <td>${c.obrigatorio ? '‚úÖ' : ''}</td>
                                <td>${c.unico ? '‚úÖ' : ''}</td>
                                <td>
                                    <button class="btn btn-xs btn-outline" onclick="editarCampo(${c.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-xs btn-outline btn-danger" onclick="confirmarExclusaoCampo(${c.id}, '${c.nome}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Fechar modal campos
        function fecharModalCampos() {
            document.getElementById('modalCampos').classList.remove('active');
        }

        // Abrir modal novo campo
        function abrirModalNovoCampo() {
            document.getElementById('modalCampoTitulo').textContent = 'Novo Campo';
            document.getElementById('formCampo').reset();
            document.getElementById('campoId').value = '';
            document.getElementById('campoCodigo').disabled = false;
            document.getElementById('campoOrdem').value = campos.length;
            document.getElementById('opcoesContainer').innerHTML = '';
            opcoesIndex = 0;
            atualizarOpcoesTipo();
            document.getElementById('modalCampo').classList.add('active');
        }

        // Editar campo
        async function editarCampo(id) {
            const campo = campos.find(c => c.id === id);
            if (!campo) return;

            document.getElementById('modalCampoTitulo').textContent = 'Editar Campo';
            document.getElementById('campoId').value = campo.id;
            document.getElementById('campoCodigo').value = campo.codigo;
            document.getElementById('campoCodigo').disabled = true;
            document.getElementById('campoNome').value = campo.nome;
            document.getElementById('campoDescricao').value = campo.descricao || '';
            document.getElementById('campoTipo').value = campo.tipo;
            document.getElementById('campoOrdem').value = campo.ordem;
            document.getElementById('campoObrigatorio').checked = campo.obrigatorio;
            document.getElementById('campoUnico').checked = campo.unico;
            document.getElementById('campoValorPadrao').value = campo.valor_padrao || '';
            document.getElementById('campoVisivelListagem').checked = campo.visivel_listagem;
            document.getElementById('campoVisivelFormulario').checked = campo.visivel_formulario;
            document.getElementById('campoVisivelMobile').checked = campo.visivel_mobile;

            // Relacao
            if (campo.relacao_entidade_id) {
                document.getElementById('relacaoEntidade').value = campo.relacao_entidade_id;
                document.getElementById('relacaoCampoExibir').value = campo.relacao_campo_exibir || '';
            }

            // Opcoes
            document.getElementById('opcoesContainer').innerHTML = '';
            opcoesIndex = 0;
            if (campo.opcoes && campo.opcoes.length > 0) {
                campo.opcoes.forEach(o => adicionarOpcao(o.valor, o.label, o.cor));
            }

            atualizarOpcoesTipo();
            document.getElementById('modalCampo').classList.add('active');
        }

        // Atualizar opcoes baseado no tipo
        function atualizarOpcoesTipo() {
            const tipo = document.getElementById('campoTipo').value;
            document.getElementById('secaoOpcoes').style.display =
                (tipo === 'select' || tipo === 'multiselect') ? 'block' : 'none';
            document.getElementById('secaoRelacao').style.display =
                tipo === 'relation' ? 'block' : 'none';
        }

        // Adicionar opcao
        function adicionarOpcao(valor = '', label = '', cor = '') {
            const container = document.getElementById('opcoesContainer');
            const div = document.createElement('div');
            div.className = 'opcao-row';
            div.innerHTML = `
                <input type="text" name="opcao_valor_${opcoesIndex}" placeholder="Valor" value="${valor}" required>
                <input type="text" name="opcao_label_${opcoesIndex}" placeholder="Label" value="${label}" required>
                <input type="color" name="opcao_cor_${opcoesIndex}" value="${cor || '#6B7280'}" title="Cor">
                <button type="button" class="btn btn-xs btn-danger" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
            opcoesIndex++;
        }

        // Salvar campo
        async function salvarCampo(event) {
            event.preventDefault();

            const id = document.getElementById('campoId').value;
            const isEdicao = !!id;
            const tipo = document.getElementById('campoTipo').value;

            const dados = {
                codigo: document.getElementById('campoCodigo').value,
                nome: document.getElementById('campoNome').value,
                descricao: document.getElementById('campoDescricao').value || null,
                tipo: tipo,
                ordem: parseInt(document.getElementById('campoOrdem').value) || 0,
                obrigatorio: document.getElementById('campoObrigatorio').checked,
                unico: document.getElementById('campoUnico').checked,
                valor_padrao: document.getElementById('campoValorPadrao').value || null,
                visivel_listagem: document.getElementById('campoVisivelListagem').checked,
                visivel_formulario: document.getElementById('campoVisivelFormulario').checked,
                visivel_mobile: document.getElementById('campoVisivelMobile').checked
            };

            // Relacao
            if (tipo === 'relation') {
                dados.relacao_entidade_id = parseInt(document.getElementById('relacaoEntidade').value) || null;
                dados.relacao_campo_exibir = document.getElementById('relacaoCampoExibir').value || null;
            }

            // Opcoes
            if (tipo === 'select' || tipo === 'multiselect') {
                const opcoes = [];
                const opcoesRows = document.querySelectorAll('.opcao-row');
                opcoesRows.forEach((row, i) => {
                    const valor = row.querySelector(`input[name^="opcao_valor"]`).value;
                    const label = row.querySelector(`input[name^="opcao_label"]`).value;
                    const cor = row.querySelector(`input[name^="opcao_cor"]`).value;
                    if (valor && label) {
                        opcoes.push({ valor, label, cor, ordem: i });
                    }
                });
                dados.opcoes = opcoes;
            }

            try {
                const url = isEdicao
                    ? `/api/projetos/${projetoAtual.id}/entidades/${entidadeAtual.id}/campos/${id}`
                    : `/api/projetos/${projetoAtual.id}/entidades/${entidadeAtual.id}/campos`;
                const method = isEdicao ? 'PUT' : 'POST';

                const res = await apiRequest(url, {
                    method,
                    body: JSON.stringify(dados)
                });

                if (res.success) {
                    showToast(isEdicao ? 'Campo atualizado!' : 'Campo criado!', 'success');
                    fecharModalCampo();
                    gerenciarCampos(entidadeAtual.id);
                } else {
                    showToast(res.error || 'Erro ao salvar', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar campo:', error);
                showToast('Erro ao salvar campo', 'error');
            }
        }

        // Fechar modal campo
        function fecharModalCampo() {
            document.getElementById('modalCampo').classList.remove('active');
        }

        // Confirmar exclusao campo
        function confirmarExclusaoCampo(id, nome) {
            if (confirm(`Deseja realmente excluir o campo "${nome}"?`)) {
                excluirCampo(id);
            }
        }

        // Excluir campo
        async function excluirCampo(id) {
            try {
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${entidadeAtual.id}/campos/${id}`, {
                    method: 'DELETE'
                });

                if (res.success) {
                    showToast('Campo excluido!', 'success');
                    gerenciarCampos(entidadeAtual.id);
                } else {
                    showToast(res.error || 'Erro ao excluir', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir campo:', error);
                showToast('Erro ao excluir campo', 'error');
            }
        }

        // Fechar modais ao clicar fora
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    modal.classList.remove('active');
                }
            });
        });

        // =========================================
        // LAYOUT BUILDER
        // =========================================

        let layoutConfig = {};
        let layoutCampos = [];
        let filtrosIndex = 0;
        let filtrosRapidosIndex = 0;
        let metricasIndex = 0;
        let statusAcoesIndex = 0;

        // Abrir layout builder
        async function abrirLayoutBuilder(entidadeId) {
            try {
                // Buscar entidade com campos
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${entidadeId}`);
                if (!res.success) {
                    showToast('Erro ao carregar entidade', 'error');
                    return;
                }

                entidadeAtual = res.entidade;
                layoutCampos = res.entidade.campos || [];

                document.getElementById('layoutEntidadeId').value = entidadeId;
                document.getElementById('modalLayoutTitulo').textContent = `Configurar Layout: ${entidadeAtual.nome}`;

                // Parse do config_funcionalidades existente
                layoutConfig = {};
                if (entidadeAtual.config_funcionalidades) {
                    try {
                        layoutConfig = typeof entidadeAtual.config_funcionalidades === 'string'
                            ? JSON.parse(entidadeAtual.config_funcionalidades)
                            : entidadeAtual.config_funcionalidades;
                    } catch (e) {
                        layoutConfig = {};
                    }
                }

                // Reset indices
                filtrosIndex = 0;
                filtrosRapidosIndex = 0;
                metricasIndex = 0;
                statusAcoesIndex = 0;

                // Inicializar builder com config atual
                inicializarLayoutBuilder();

                // Mostrar primeira aba
                mostrarSecaoLayout('layout');

                document.getElementById('modalLayoutBuilder').classList.add('active');
            } catch (error) {
                console.error('Erro ao abrir layout builder:', error);
                showToast('Erro ao abrir configuracao de layout', 'error');
            }
        }

        // Fechar layout builder
        function fecharLayoutBuilder() {
            document.getElementById('modalLayoutBuilder').classList.remove('active');
        }

        // Mostrar secao do layout builder
        function mostrarSecaoLayout(secao) {
            // Atualizar tabs
            document.querySelectorAll('.layout-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.layout-tab[onclick*="${secao}"]`).classList.add('active');

            // Atualizar secoes
            document.querySelectorAll('.layout-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`secao${secao.charAt(0).toUpperCase() + secao.slice(1)}`).classList.add('active');
        }

        // Inicializar layout builder com config atual
        function inicializarLayoutBuilder() {
            // Tipo de layout
            const tipoLayout = layoutConfig.layout || 'tabela';
            document.querySelectorAll('.layout-type-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.layout === tipoLayout);
            });

            // Campo de agrupamento
            const selectAgrupamento = document.getElementById('campoAgrupamento');
            selectAgrupamento.innerHTML = '<option value="">Selecione...</option>' +
                layoutCampos.filter(c => c.tipo === 'select').map(c =>
                    `<option value="${c.codigo}" ${layoutConfig.agrupamento?.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');
            document.getElementById('opcoesAgrupamento').style.display = tipoLayout === 'cards_agrupados' ? 'block' : 'none';

            // Campos de timeline
            const timelineConfig = layoutConfig.timeline || {};
            const selectTimelineData = document.getElementById('timelineCampoData');
            const selectTimelineTitulo = document.getElementById('timelineCampoTitulo');
            const selectTimelineDescricao = document.getElementById('timelineCampoDescricao');

            // Popular select de data (campos tipo date ou datetime)
            selectTimelineData.innerHTML = '<option value="">Selecione...</option>' +
                layoutCampos.filter(c => ['date', 'datetime', 'data'].includes(c.tipo)).map(c =>
                    `<option value="${c.codigo}" ${timelineConfig.campo_data === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

            // Popular select de titulo (todos os campos texto)
            selectTimelineTitulo.innerHTML = '<option value="">Selecione...</option>' +
                layoutCampos.filter(c => ['texto', 'text', 'varchar'].includes(c.tipo)).map(c =>
                    `<option value="${c.codigo}" ${timelineConfig.campo_titulo === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

            // Popular select de descricao (campos texto ou textarea)
            selectTimelineDescricao.innerHTML = '<option value="">Selecione...</option>' +
                layoutCampos.filter(c => ['texto', 'text', 'varchar', 'textarea', 'texto_longo'].includes(c.tipo)).map(c =>
                    `<option value="${c.codigo}" ${timelineConfig.campo_descricao === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

            document.getElementById('opcoesTimeline').style.display = tipoLayout === 'timeline' ? 'block' : 'none';

            // Campos de avatar (para cards_grid)
            const avatarConfig = layoutConfig.card?.avatar || {};
            const selectAvatarCampo = document.getElementById('avatarCampo');
            const selectAvatarCorPor = document.getElementById('avatarCorPor');

            // Popular select de campo para avatar (campos texto/nome)
            selectAvatarCampo.innerHTML = '<option value="">Selecione...</option>' +
                layoutCampos.filter(c => ['texto', 'text', 'varchar'].includes(c.tipo)).map(c =>
                    `<option value="${c.codigo}" ${avatarConfig.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

            // Popular select de cor por (campos select)
            selectAvatarCorPor.innerHTML = '<option value="">Nenhum</option>' +
                layoutCampos.filter(c => c.tipo === 'select').map(c =>
                    `<option value="${c.codigo}" ${avatarConfig.cor_por === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

            document.getElementById('opcoesAvatar').style.display = tipoLayout === 'cards_grid' ? 'block' : 'none';

            // Colunas
            renderizarColunasBuilder();

            // Secoes do card (visivel apenas para layouts de cards)
            const isCardLayoutInit = ['cards', 'cards_grid', 'cards_agrupados'].includes(tipoLayout);
            document.getElementById('secaoSecoesCard').style.display = isCardLayoutInit ? 'block' : 'none';
            renderizarSecoesBuilder();

            // Filtros
            renderizarFiltrosBuilder();

            // Filtros rapidos
            renderizarFiltrosRapidosBuilder();

            // Metricas
            const temMetricas = layoutConfig.metricas && layoutConfig.metricas.cards && layoutConfig.metricas.cards.length > 0;
            document.getElementById('habilitarMetricas').checked = temMetricas;
            document.getElementById('metricasConfig').style.display = temMetricas ? 'block' : 'none';
            renderizarMetricasBuilder();

            // Acoes
            document.getElementById('acaoVerDetalhes').checked = layoutConfig.modal !== false;
            document.getElementById('acaoEditar').checked = layoutConfig.acoes?.includes('editar') || false;
            document.getElementById('acaoExcluir').checked = layoutConfig.acoes?.includes('excluir') || false;
            document.getElementById('acaoTeams').checked = layoutConfig.acoes?.includes('teams') || false;
            document.getElementById('acaoExportarCSV').checked = layoutConfig.acoes?.includes('exportar_csv') || layoutConfig.exportar?.csv !== false;
            document.getElementById('acaoImportarCSV').checked = layoutConfig.acoes?.includes('importar_csv') || false;

            // Acoes de status
            renderizarStatusAcoesBuilder();
        }

        // Selecionar tipo de layout
        function selecionarLayoutTipo(tipo) {
            document.querySelectorAll('.layout-type-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.layout === tipo);
            });
            layoutConfig.layout = tipo;

            const isCardLayout = ['cards', 'cards_grid', 'cards_agrupados'].includes(tipo);

            // Mostrar/ocultar opcoes de agrupamento
            document.getElementById('opcoesAgrupamento').style.display = tipo === 'cards_agrupados' ? 'block' : 'none';

            // Mostrar/ocultar opcoes de timeline
            const timelineOpcoes = document.getElementById('opcoesTimeline');
            if (timelineOpcoes) {
                timelineOpcoes.style.display = tipo === 'timeline' ? 'block' : 'none';
            }

            // Mostrar/ocultar opcoes de avatar
            const avatarOpcoes = document.getElementById('opcoesAvatar');
            if (avatarOpcoes) {
                avatarOpcoes.style.display = tipo === 'cards_grid' ? 'block' : 'none';
            }

            // Mostrar/ocultar secao de secoes do card
            const secaoSecoesCard = document.getElementById('secaoSecoesCard');
            if (secaoSecoesCard) {
                secaoSecoesCard.style.display = isCardLayout ? 'block' : 'none';
            }

            // Re-renderizar colunas para mostrar/ocultar opcoes de estilo (cards)
            renderizarColunasBuilder();
        }

        // Renderizar colunas no builder
        function renderizarColunasBuilder() {
            const container = document.getElementById('colunasListBuilder');

            if (layoutCampos.length === 0) {
                container.innerHTML = '<p class="empty">Nenhum campo configurado. Adicione campos primeiro.</p>';
                return;
            }

            // Ordenar campos pela ordem no config ou pela ordem natural
            const colunasConfig = layoutConfig.colunas || [];
            const camposOrdenados = [...layoutCampos].sort((a, b) => {
                const idxA = colunasConfig.findIndex(c => c.campo === a.codigo);
                const idxB = colunasConfig.findIndex(c => c.campo === b.codigo);
                if (idxA === -1 && idxB === -1) return a.ordem - b.ordem;
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });

            // Verificar se layout atual e de cards (precisa de estilo)
            const layoutAtual = document.querySelector('.layout-type-btn.selected')?.dataset.layout || 'tabela';
            const isCardLayout = ['cards', 'cards_grid', 'cards_agrupados'].includes(layoutAtual);

            // Buscar config de card.campos se existir
            const cardCampos = layoutConfig.card?.campos || [];

            container.innerHTML = camposOrdenados.map((campo, index) => {
                const colConfig = colunasConfig.find(c => c.campo === campo.codigo) || {};
                const cardConfig = cardCampos.find(c => c.campo === campo.codigo) || {};
                const visivel = colConfig.visivel !== false && campo.visivel_listagem !== false;
                const estilo = cardConfig.estilo || colConfig.estilo || '';
                const cor = cardConfig.cor || colConfig.cor || '';

                return `
                    <div class="coluna-item" data-codigo="${campo.codigo}" draggable="true">
                        <span class="coluna-drag">‚ãÆ‚ãÆ</span>
                        <label class="checkbox-item">
                            <input type="checkbox" class="coluna-visivel" data-campo="${campo.codigo}" ${visivel ? 'checked' : ''}>
                            <span class="coluna-nome">${campo.nome}</span>
                            <code class="coluna-codigo">${campo.codigo}</code>
                        </label>
                        <span class="coluna-tipo tipo-badge tipo-${campo.tipo}">${campo.tipo}</span>
                        <input type="text" class="coluna-largura" data-campo="${campo.codigo}"
                               placeholder="auto" value="${colConfig.largura || ''}" title="Largura (ex: 100px, auto)">
                        ${isCardLayout ? `
                        <select class="coluna-estilo" data-campo="${campo.codigo}" title="Estilo no card">
                            <option value="">-- Estilo --</option>
                            <option value="titulo" ${estilo === 'titulo' ? 'selected' : ''}>Titulo</option>
                            <option value="subtitulo" ${estilo === 'subtitulo' ? 'selected' : ''}>Subtitulo</option>
                            <option value="descricao" ${estilo === 'descricao' ? 'selected' : ''}>Descricao</option>
                            <option value="badge" ${estilo === 'badge' ? 'selected' : ''}>Badge</option>
                            <option value="tags" ${estilo === 'tags' ? 'selected' : ''}>Tags</option>
                        </select>
                        <input type="color" class="coluna-cor" data-campo="${campo.codigo}"
                               value="${cor || '#003B4A'}" title="Cor (para titulo/badge)">
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Adicionar eventos de drag and drop
            inicializarDragDropColunas();
        }

        // Inicializar drag and drop para colunas
        function inicializarDragDropColunas() {
            const container = document.getElementById('colunasListBuilder');
            let draggedItem = null;

            container.querySelectorAll('.coluna-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    draggedItem = null;
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedItem);
                    } else {
                        container.insertBefore(draggedItem, afterElement);
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.coluna-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Renderizar filtros no builder
        function renderizarFiltrosBuilder() {
            const container = document.getElementById('filtrosListBuilder');
            const filtros = layoutConfig.filtros || [];

            if (filtros.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = filtros.map((filtro, index) => {
                filtrosIndex = Math.max(filtrosIndex, index + 1);
                return criarFiltroHTML(index, filtro);
            }).join('');
        }

        function criarFiltroHTML(index, filtro = {}) {
            return `
                <div class="filtro-row" data-index="${index}">
                    <select class="filtro-campo" name="filtro_campo_${index}">
                        <option value="">Campo...</option>
                        ${layoutCampos.map(c => `<option value="${c.codigo}" ${filtro.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                        <option value="_busca" ${filtro.campo === '_busca' ? 'selected' : ''}>Busca geral</option>
                    </select>
                    <select class="filtro-tipo" name="filtro_tipo_${index}">
                        <option value="select" ${filtro.tipo === 'select' ? 'selected' : ''}>Dropdown</option>
                        <option value="text" ${filtro.tipo === 'text' ? 'selected' : ''}>Texto</option>
                        <option value="date" ${filtro.tipo === 'date' ? 'selected' : ''}>Data</option>
                    </select>
                    <input type="text" class="filtro-placeholder" name="filtro_placeholder_${index}"
                           placeholder="Placeholder" value="${filtro.placeholder || ''}">
                    <button type="button" class="btn btn-xs btn-danger" onclick="removerFiltro(${index})">üóëÔ∏è</button>
                </div>
            `;
        }

        function adicionarFiltro() {
            const container = document.getElementById('filtrosListBuilder');
            container.insertAdjacentHTML('beforeend', criarFiltroHTML(filtrosIndex));
            filtrosIndex++;
        }

        function removerFiltro(index) {
            document.querySelector(`.filtro-row[data-index="${index}"]`).remove();
        }

        // Renderizar filtros rapidos
        function renderizarFiltrosRapidosBuilder() {
            const container = document.getElementById('filtrosRapidosListBuilder');
            const botoes = layoutConfig.filtros_botoes || [];

            if (botoes.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = botoes.map((btn, index) => {
                filtrosRapidosIndex = Math.max(filtrosRapidosIndex, index + 1);
                return criarFiltroRapidoHTML(index, btn);
            }).join('');
        }

        function criarFiltroRapidoHTML(index, btn = {}) {
            return `
                <div class="filtro-rapido-row" data-index="${index}">
                    <input type="text" name="fr_label_${index}" placeholder="Label" value="${btn.label || ''}">
                    <select name="fr_campo_${index}">
                        <option value="">Campo...</option>
                        ${layoutCampos.filter(c => c.tipo === 'select').map(c =>
                            `<option value="${c.codigo}" ${btn.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                        ).join('')}
                    </select>
                    <input type="text" name="fr_valor_${index}" placeholder="Valor" value="${btn.valor || ''}">
                    <input type="text" name="fr_icone_${index}" placeholder="Icone" value="${btn.icone || ''}" style="width: 60px;">
                    <button type="button" class="btn btn-xs btn-danger" onclick="removerFiltroRapido(${index})">üóëÔ∏è</button>
                </div>
            `;
        }

        function adicionarFiltroRapido() {
            const container = document.getElementById('filtrosRapidosListBuilder');
            container.insertAdjacentHTML('beforeend', criarFiltroRapidoHTML(filtrosRapidosIndex));
            filtrosRapidosIndex++;
        }

        function removerFiltroRapido(index) {
            document.querySelector(`.filtro-rapido-row[data-index="${index}"]`).remove();
        }

        // Toggle metricas
        function toggleMetricas() {
            const habilitado = document.getElementById('habilitarMetricas').checked;
            document.getElementById('metricasConfig').style.display = habilitado ? 'block' : 'none';
        }

        // Renderizar metricas
        function renderizarMetricasBuilder() {
            const container = document.getElementById('metricasListBuilder');
            const cards = layoutConfig.metricas?.cards || [];

            if (cards.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = cards.map((card, index) => {
                metricasIndex = Math.max(metricasIndex, index + 1);
                return criarMetricaHTML(index, card);
            }).join('');
        }

        function criarMetricaHTML(index, card = {}) {
            return `
                <div class="metrica-row" data-index="${index}">
                    <input type="text" name="metrica_icone_${index}" placeholder="Icone" value="${card.icone || ''}" style="width: 60px;">
                    <input type="text" name="metrica_label_${index}" placeholder="Label" value="${card.label || ''}">
                    <select name="metrica_tipo_${index}">
                        <option value="total" ${card.tipo === 'total' ? 'selected' : ''}>Total</option>
                        <option value="contador" ${card.tipo === 'contador' ? 'selected' : ''}>Contador (filtro)</option>
                        <option value="distinct" ${card.tipo === 'distinct' ? 'selected' : ''}>Distinct</option>
                        <option value="soma" ${card.tipo === 'soma' ? 'selected' : ''}>Soma</option>
                    </select>
                    <select name="metrica_campo_${index}">
                        <option value="">Campo...</option>
                        ${layoutCampos.map(c => `<option value="${c.codigo}" ${card.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                    </select>
                    <input type="text" name="metrica_valor_${index}" placeholder="Valor (p/ contador)" value="${card.valor || ''}" style="width: 100px;">
                    <input type="color" name="metrica_cor_${index}" value="${card.cor || '#003B4A'}" title="Cor do card" class="metrica-cor">
                    <button type="button" class="btn btn-xs btn-danger" onclick="removerMetrica(${index})">üóëÔ∏è</button>
                </div>
            `;
        }

        function adicionarMetrica() {
            const container = document.getElementById('metricasListBuilder');
            container.insertAdjacentHTML('beforeend', criarMetricaHTML(metricasIndex));
            metricasIndex++;
        }

        function removerMetrica(index) {
            document.querySelector(`.metrica-row[data-index="${index}"]`).remove();
        }

        // Renderizar acoes de status
        function renderizarStatusAcoesBuilder() {
            const container = document.getElementById('statusAcoesBuilder');
            const acoesStatus = layoutConfig.acoes_status || [];

            if (acoesStatus.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = acoesStatus.map((acao, index) => {
                statusAcoesIndex = Math.max(statusAcoesIndex, index + 1);
                return criarAcaoStatusHTML(index, acao);
            }).join('');
        }

        function criarAcaoStatusHTML(index, acao = {}) {
            return `
                <div class="status-acao-row" data-index="${index}">
                    <input type="text" name="status_icone_${index}" placeholder="Icone" value="${acao.icone || ''}" style="width: 60px;">
                    <input type="text" name="status_label_${index}" placeholder="Label" value="${acao.label || ''}">
                    <select name="status_campo_${index}">
                        <option value="">Campo status...</option>
                        ${layoutCampos.filter(c => c.tipo === 'select').map(c =>
                            `<option value="${c.codigo}" ${acao.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`
                        ).join('')}
                    </select>
                    <input type="text" name="status_valor_${index}" placeholder="Novo valor" value="${acao.valor || ''}">
                    <button type="button" class="btn btn-xs btn-danger" onclick="removerAcaoStatus(${index})">üóëÔ∏è</button>
                </div>
            `;
        }

        function adicionarAcaoStatus() {
            const container = document.getElementById('statusAcoesBuilder');
            container.insertAdjacentHTML('beforeend', criarAcaoStatusHTML(statusAcoesIndex));
            statusAcoesIndex++;
        }

        function removerAcaoStatus(index) {
            document.querySelector(`.status-acao-row[data-index="${index}"]`).remove();
        }

        // ============ SECOES DO CARD ============
        let secoesIndex = 0;

        function renderizarSecoesBuilder() {
            const container = document.getElementById('secoesListBuilder');
            const secoes = layoutConfig.card?.secoes || [];

            if (secoes.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = secoes.map((secao, index) => {
                secoesIndex = Math.max(secoesIndex, index + 1);
                return criarSecaoHTML(index, secao);
            }).join('');
        }

        function criarSecaoHTML(index, secao = {}) {
            const tiposSecao = [
                { value: 'comparativo', label: 'Comparativo (Antes/Depois)' },
                { value: 'comparativo_detalhado', label: 'Comparativo AS-IS/TO-BE' },
                { value: 'badges', label: 'Badges (Tags)' },
                { value: 'passos', label: 'Passos Numerados' },
                { value: 'info_grid', label: 'Grid de Informacoes' },
                { value: 'texto', label: 'Texto Simples' },
                { value: 'lista', label: 'Lista' }
            ];

            return `
                <div class="secao-row" data-index="${index}">
                    <select name="secao_tipo_${index}" onchange="atualizarCamposSecao(${index})">
                        <option value="">Tipo de Secao...</option>
                        ${tiposSecao.map(t => `<option value="${t.value}" ${secao.tipo === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                    </select>
                    <input type="text" name="secao_titulo_${index}" placeholder="Titulo (opcional)" value="${secao.titulo || ''}">
                    <div class="secao-campos-config" id="secaoCampos_${index}">
                        ${renderizarCamposSecao(index, secao)}
                    </div>
                    <button type="button" class="btn btn-xs btn-danger" onclick="removerSecaoCard(${index})">üóëÔ∏è</button>
                </div>
            `;
        }

        function renderizarCamposSecao(index, secao = {}) {
            const tipo = secao.tipo || '';

            if (tipo === 'comparativo') {
                const campos = secao.campos || ['', ''];
                return `
                    <select name="secao_campo1_${index}" title="Campo Antes">
                        <option value="">Campo Antes...</option>
                        ${layoutCampos.map(c => `<option value="${c.codigo}" ${campos[0] === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                    </select>
                    <select name="secao_campo2_${index}" title="Campo Depois">
                        <option value="">Campo Depois...</option>
                        ${layoutCampos.map(c => `<option value="${c.codigo}" ${campos[1] === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                    </select>
                `;
            } else if (tipo === 'comparativo_detalhado') {
                const asIs = secao.as_is || {};
                const toBe = secao.to_be || {};
                return `
                    <div class="secao-comparativo-config">
                        <div class="comparativo-coluna">
                            <strong>AS-IS:</strong>
                            <select name="secao_asis_titulo_${index}">
                                <option value="">Titulo...</option>
                                ${layoutCampos.map(c => `<option value="${c.codigo}" ${asIs.titulo === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                            <select name="secao_asis_desc_${index}">
                                <option value="">Descricao...</option>
                                ${layoutCampos.map(c => `<option value="${c.codigo}" ${asIs.descricao === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="comparativo-coluna">
                            <strong>TO-BE:</strong>
                            <select name="secao_tobe_titulo_${index}">
                                <option value="">Titulo...</option>
                                ${layoutCampos.map(c => `<option value="${c.codigo}" ${toBe.titulo === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                            <select name="secao_tobe_desc_${index}">
                                <option value="">Descricao...</option>
                                ${layoutCampos.map(c => `<option value="${c.codigo}" ${toBe.descricao === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            } else if (tipo === 'badges' || tipo === 'texto' || tipo === 'lista' || tipo === 'passos') {
                return `
                    <select name="secao_campo_${index}">
                        <option value="">Selecione campo...</option>
                        ${layoutCampos.map(c => `<option value="${c.codigo}" ${secao.campo === c.codigo ? 'selected' : ''}>${c.nome}</option>`).join('')}
                    </select>
                `;
            } else if (tipo === 'info_grid') {
                const campos = secao.campos || [];
                return `
                    <input type="text" name="secao_campos_${index}" placeholder="Campos (separados por virgula)"
                           value="${campos.map(c => c.campo || c).join(', ')}" style="width: 200px;">
                `;
            }

            return '';
        }

        function atualizarCamposSecao(index) {
            const tipo = document.querySelector(`[name="secao_tipo_${index}"]`).value;
            const container = document.getElementById(`secaoCampos_${index}`);
            container.innerHTML = renderizarCamposSecao(index, { tipo });
        }

        function adicionarSecaoCard() {
            const container = document.getElementById('secoesListBuilder');
            container.insertAdjacentHTML('beforeend', criarSecaoHTML(secoesIndex));
            secoesIndex++;
        }

        function removerSecaoCard(index) {
            document.querySelector(`.secao-row[data-index="${index}"]`).remove();
        }

        // Salvar configuracao de layout
        async function salvarLayoutConfig() {
            const entidadeId = document.getElementById('layoutEntidadeId').value;

            // Coletar layout tipo
            const layoutTipoBtn = document.querySelector('.layout-type-btn.selected');
            const layoutTipo = layoutTipoBtn ? layoutTipoBtn.dataset.layout : 'tabela';

            // Verificar se layout e de cards
            const isCardLayout = ['cards', 'cards_grid', 'cards_agrupados'].includes(layoutTipo);

            // Coletar colunas na ordem atual
            const colunas = [];
            const cardCampos = [];
            document.querySelectorAll('.coluna-item').forEach(item => {
                const codigo = item.dataset.codigo;
                const visivel = item.querySelector('.coluna-visivel').checked;
                const largura = item.querySelector('.coluna-largura').value;
                const estiloSelect = item.querySelector('.coluna-estilo');
                const corInput = item.querySelector('.coluna-cor');
                const estilo = estiloSelect ? estiloSelect.value : '';
                const cor = corInput ? corInput.value : '';

                colunas.push({
                    campo: codigo,
                    visivel,
                    largura: largura || undefined
                });

                // Se tem estilo definido, adicionar ao cardCampos
                if (isCardLayout && estilo && visivel) {
                    const campoConfig = { campo: codigo, estilo };
                    if (cor && cor !== '#003B4A') {
                        campoConfig.cor = cor;
                    }
                    cardCampos.push(campoConfig);
                }
            });

            // Coletar filtros
            const filtros = [];
            document.querySelectorAll('.filtro-row').forEach(row => {
                const index = row.dataset.index;
                const campo = row.querySelector(`[name="filtro_campo_${index}"]`).value;
                const tipo = row.querySelector(`[name="filtro_tipo_${index}"]`).value;
                const placeholder = row.querySelector(`[name="filtro_placeholder_${index}"]`).value;
                if (campo) {
                    filtros.push({ campo, tipo, placeholder: placeholder || undefined });
                }
            });

            // Coletar filtros rapidos
            const filtrosBotoes = [];
            document.querySelectorAll('.filtro-rapido-row').forEach(row => {
                const index = row.dataset.index;
                const label = row.querySelector(`[name="fr_label_${index}"]`).value;
                const campo = row.querySelector(`[name="fr_campo_${index}"]`).value;
                const valor = row.querySelector(`[name="fr_valor_${index}"]`).value;
                const icone = row.querySelector(`[name="fr_icone_${index}"]`).value;
                if (label && campo && valor) {
                    filtrosBotoes.push({ label, campo, valor, icone: icone || undefined });
                }
            });

            // Coletar metricas
            let metricas = null;
            if (document.getElementById('habilitarMetricas').checked) {
                const cards = [];
                document.querySelectorAll('.metrica-row').forEach(row => {
                    const index = row.dataset.index;
                    const icone = row.querySelector(`[name="metrica_icone_${index}"]`).value;
                    const label = row.querySelector(`[name="metrica_label_${index}"]`).value;
                    const tipo = row.querySelector(`[name="metrica_tipo_${index}"]`).value;
                    const campo = row.querySelector(`[name="metrica_campo_${index}"]`).value;
                    const valor = row.querySelector(`[name="metrica_valor_${index}"]`).value;
                    const cor = row.querySelector(`[name="metrica_cor_${index}"]`)?.value;
                    if (label) {
                        const metricaConfig = {
                            icone: icone || undefined,
                            label,
                            tipo,
                            campo: campo || undefined,
                            valor: valor || undefined
                        };
                        if (cor && cor !== '#003B4A') {
                            metricaConfig.cor = cor;
                        }
                        cards.push(metricaConfig);
                    }
                });
                if (cards.length > 0) {
                    metricas = { cards };
                }
            }

            // Coletar acoes
            const acoes = [];
            if (document.getElementById('acaoEditar').checked) acoes.push('editar');
            if (document.getElementById('acaoExcluir').checked) acoes.push('excluir');
            if (document.getElementById('acaoTeams').checked) acoes.push('teams');
            if (document.getElementById('acaoExportarCSV').checked) acoes.push('exportar_csv');
            if (document.getElementById('acaoImportarCSV').checked) acoes.push('importar_csv');

            // Coletar acoes de status
            const acoesStatus = [];
            document.querySelectorAll('.status-acao-row').forEach(row => {
                const index = row.dataset.index;
                const icone = row.querySelector(`[name="status_icone_${index}"]`).value;
                const label = row.querySelector(`[name="status_label_${index}"]`).value;
                const campo = row.querySelector(`[name="status_campo_${index}"]`).value;
                const valor = row.querySelector(`[name="status_valor_${index}"]`).value;
                if (label && campo && valor) {
                    acoesStatus.push({ icone: icone || undefined, label, campo, valor });
                }
            });

            // Montar config
            const config = {
                layout: layoutTipo,
                colunas,
                filtros: filtros.length > 0 ? filtros : undefined,
                filtros_botoes: filtrosBotoes.length > 0 ? filtrosBotoes : undefined,
                metricas,
                modal: document.getElementById('acaoVerDetalhes').checked,
                acoes: acoes.length > 0 ? acoes : undefined,
                acoes_status: acoesStatus.length > 0 ? acoesStatus : undefined
            };

            // Adicionar card.campos e secoes para layouts de cards
            if (isCardLayout) {
                config.card = {};

                if (cardCampos.length > 0) {
                    config.card.campos = cardCampos;
                }

                // Adicionar acoes do card se Teams estiver habilitado
                if (document.getElementById('acaoTeams')?.checked) {
                    config.card.acoes = ['teams'];
                }

                // Coletar secoes do card
                const secoes = [];
                document.querySelectorAll('.secao-row').forEach(row => {
                    const index = row.dataset.index;
                    const tipo = row.querySelector(`[name="secao_tipo_${index}"]`)?.value;
                    const titulo = row.querySelector(`[name="secao_titulo_${index}"]`)?.value;

                    if (!tipo) return;

                    const secaoConfig = { tipo };
                    if (titulo) secaoConfig.titulo = titulo;

                    // Coletar campos especificos do tipo
                    if (tipo === 'comparativo') {
                        const campo1 = row.querySelector(`[name="secao_campo1_${index}"]`)?.value;
                        const campo2 = row.querySelector(`[name="secao_campo2_${index}"]`)?.value;
                        if (campo1 || campo2) {
                            secaoConfig.campos = [campo1 || '', campo2 || ''];
                        }
                    } else if (tipo === 'comparativo_detalhado') {
                        const asisTitulo = row.querySelector(`[name="secao_asis_titulo_${index}"]`)?.value;
                        const asisDesc = row.querySelector(`[name="secao_asis_desc_${index}"]`)?.value;
                        const tobeTitulo = row.querySelector(`[name="secao_tobe_titulo_${index}"]`)?.value;
                        const tobeDesc = row.querySelector(`[name="secao_tobe_desc_${index}"]`)?.value;
                        if (asisTitulo || asisDesc) {
                            secaoConfig.as_is = {};
                            if (asisTitulo) secaoConfig.as_is.titulo = asisTitulo;
                            if (asisDesc) secaoConfig.as_is.descricao = asisDesc;
                        }
                        if (tobeTitulo || tobeDesc) {
                            secaoConfig.to_be = {};
                            if (tobeTitulo) secaoConfig.to_be.titulo = tobeTitulo;
                            if (tobeDesc) secaoConfig.to_be.descricao = tobeDesc;
                        }
                    } else if (tipo === 'info_grid') {
                        const camposStr = row.querySelector(`[name="secao_campos_${index}"]`)?.value || '';
                        const campos = camposStr.split(',').map(c => c.trim()).filter(c => c);
                        if (campos.length > 0) {
                            secaoConfig.campos = campos.map(c => ({ campo: c }));
                        }
                    } else {
                        const campo = row.querySelector(`[name="secao_campo_${index}"]`)?.value;
                        if (campo) secaoConfig.campo = campo;
                    }

                    secoes.push(secaoConfig);
                });

                if (secoes.length > 0) {
                    config.card.secoes = secoes;
                }

                // Avatar config (para cards_grid)
                if (layoutTipo === 'cards_grid') {
                    const avatarCampo = document.getElementById('avatarCampo').value;
                    const avatarCorPor = document.getElementById('avatarCorPor').value;

                    if (avatarCampo) {
                        config.card.avatar = { campo: avatarCampo };
                        if (avatarCorPor) {
                            config.card.avatar.cor_por = avatarCorPor;
                        }
                    }
                }
            }

            // Adicionar agrupamento se necessario
            if (layoutTipo === 'cards_agrupados') {
                const campoAgrupamento = document.getElementById('campoAgrupamento').value;
                if (campoAgrupamento) {
                    config.agrupamento = { campo: campoAgrupamento };
                }
            }

            // Timeline config
            if (layoutTipo === 'timeline') {
                const campoData = document.getElementById('timelineCampoData').value;
                const campoTitulo = document.getElementById('timelineCampoTitulo').value;
                const campoDescricao = document.getElementById('timelineCampoDescricao').value;

                if (campoData || campoTitulo || campoDescricao) {
                    config.timeline = {};
                    if (campoData) config.timeline.campo_data = campoData;
                    if (campoTitulo) config.timeline.campo_titulo = campoTitulo;
                    if (campoDescricao) config.timeline.campo_descricao = campoDescricao;
                }
            }

            // Salvar via API
            try {
                const res = await apiRequest(`/api/projetos/${projetoAtual.id}/entidades/${entidadeId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        config_funcionalidades: config
                    })
                });

                if (res.success) {
                    showToast('Configuracao de layout salva!', 'success');
                    fecharLayoutBuilder();
                    carregarEntidades();
                } else {
                    showToast(res.error || 'Erro ao salvar', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar layout:', error);
                showToast('Erro ao salvar configuracao', 'error');
            }
        }

        // Inicializar
        checkAuth().then(() => {
            carregarProjetos();
        });
    </script>

    <style>
        /* Estilos especificos para entidades */
        .header-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .select-projeto {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .projeto-info-banner {
            background: linear-gradient(135deg, #003B4A 0%, #00A799 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .projeto-banner-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .projeto-banner-content .projeto-icone {
            font-size: 48px;
        }

        .projeto-banner-content h3 {
            margin: 0;
            font-size: 24px;
        }

        .projeto-banner-content p {
            margin: 4px 0 0 0;
            opacity: 0.9;
        }

        .stats-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .entidades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .entidade-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #003B4A;
        }

        .entidade-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .entidade-icone {
            font-size: 32px;
        }

        .entidade-info {
            flex: 1;
        }

        .entidade-nome {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .entidade-codigo {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .entidade-tipo {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .tipo-tabela { background: #dbeafe; color: #1e40af; }
        .tipo-documento { background: #fef3c7; color: #92400e; }
        .tipo-arquivo { background: #d1fae5; color: #065f46; }

        .entidade-descricao {
            font-size: 14px;
            color: #666;
            margin: 0 0 12px 0;
        }

        .entidade-permissoes {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .perm-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f3f4f6;
            color: #4b5563;
        }

        .entidade-actions {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        /* Instrucoes */
        .instrucoes-content {
            text-align: center;
            padding: 40px;
        }

        .instrucoes-icon {
            font-size: 64px;
            display: block;
            margin-bottom: 16px;
        }

        .instrucoes-content h3 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .instrucoes-content p {
            margin: 8px 0;
            color: #666;
        }

        /* Campos table */
        .campos-toolbar {
            margin-bottom: 16px;
        }

        .campos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .campos-table th,
        .campos-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .campos-table th {
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .campos-table code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .tipo-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .tipo-text { background: #e0e7ff; color: #3730a3; }
        .tipo-textarea { background: #e0e7ff; color: #3730a3; }
        .tipo-number { background: #fef3c7; color: #92400e; }
        .tipo-currency { background: #fef3c7; color: #92400e; }
        .tipo-date { background: #dbeafe; color: #1e40af; }
        .tipo-datetime { background: #dbeafe; color: #1e40af; }
        .tipo-boolean { background: #d1fae5; color: #065f46; }
        .tipo-select { background: #fce7f3; color: #9d174d; }
        .tipo-multiselect { background: #fce7f3; color: #9d174d; }
        .tipo-file { background: #e5e7eb; color: #374151; }
        .tipo-image { background: #e5e7eb; color: #374151; }
        .tipo-relation { background: #ede9fe; color: #5b21b6; }

        /* Opcoes */
        .opcao-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .opcao-row input[type="text"] {
            flex: 1;
        }

        .opcao-row input[type="color"] {
            width: 40px;
            height: 36px;
            border: none;
            cursor: pointer;
        }

        /* Modal sizes */
        .modal-xl {
            max-width: 900px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Form section */
        .form-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .form-section-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .checkbox-item input {
            cursor: pointer;
        }

        /* Toast */
        .toast-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: toastSlideIn 0.3s ease;
        }

        .toast-success { background: #00A799; }
        .toast-error { background: #ED1C24; }
        .toast-info { background: #003B4A; }

        .toast-hide {
            animation: toastSlideOut 0.3s ease forwards;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .stats-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .entidades-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Layout Builder Styles */
        .layout-builder-body {
            padding: 0;
        }

        .layout-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f9f9f9;
            margin: -20px -20px 20px -20px;
            padding: 0 20px;
        }

        .layout-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .layout-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .layout-tab.active {
            color: #003B4A;
            border-bottom-color: #003B4A;
            font-weight: 600;
        }

        .layout-section {
            display: none;
            padding: 20px;
        }

        .layout-section.active {
            display: block;
        }

        .layout-section h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #333;
        }

        .layout-section h5 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #333;
        }

        .section-help {
            color: #666;
            font-size: 13px;
            margin-bottom: 16px;
        }

        /* Layout type selection */
        .layout-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .layout-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 16px 12px;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layout-type-btn:hover {
            border-color: #003B4A;
            background: #f0f0f0;
        }

        .layout-type-btn.selected {
            border-color: #003B4A;
            background: #e6f2f4;
        }

        .layout-type-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .layout-type-nome {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .layout-type-desc {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .layout-subsection {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Colunas builder */
        .colunas-list {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
        }

        .coluna-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            transition: box-shadow 0.2s;
        }

        .coluna-item:last-child {
            margin-bottom: 0;
        }

        .coluna-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .coluna-item.dragging {
            opacity: 0.5;
        }

        .coluna-drag {
            color: #999;
            cursor: grab;
        }

        .coluna-item .checkbox-item {
            flex: 1;
            gap: 8px;
        }

        .coluna-nome {
            font-weight: 500;
        }

        .coluna-codigo {
            font-size: 11px;
            color: #888;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .coluna-largura {
            width: 80px;
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .coluna-estilo {
            width: 110px;
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .coluna-cor,
        .metrica-cor {
            width: 40px;
            height: 28px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Filtros builder */
        .filtros-builder {
            margin-bottom: 20px;
        }

        .filtro-row,
        .filtro-rapido-row,
        .metrica-row,
        .status-acao-row,
        .secao-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .filtro-row select,
        .filtro-row input,
        .filtro-rapido-row select,
        .filtro-rapido-row input,
        .metrica-row select,
        .metrica-row input,
        .status-acao-row select,
        .status-acao-row input,
        .secao-row select,
        .secao-row input {
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .secao-row {
            flex-wrap: wrap;
        }

        .secao-campos-config {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .secao-comparativo-config {
            display: flex;
            gap: 16px;
            width: 100%;
            margin-top: 8px;
        }

        .comparativo-coluna {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .comparativo-coluna strong {
            font-size: 12px;
            color: #666;
        }

        .filtro-campo,
        .filtro-tipo {
            width: 140px;
        }

        .filtro-placeholder {
            flex: 1;
        }

        /* Acoes checklist */
        .acoes-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .acoes-checklist .checkbox-item {
            background: #f9f9f9;
            padding: 8px 12px;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .layout-tabs {
                overflow-x: auto;
            }

            .layout-tab {
                padding: 12px 16px;
                white-space: nowrap;
            }

            .layout-type-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .coluna-item {
                flex-wrap: wrap;
            }

            .filtro-row,
            .filtro-rapido-row,
            .metrica-row,
            .status-acao-row {
                flex-wrap: wrap;
            }
        }
    </style>
</body>
</html>
